(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{453:function(t,s,a){"use strict";a.r(s);var e=a(46),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_3-redis集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-redis集群"}},[t._v("#")]),t._v(" 3.Redis集群")]),t._v(" "),a("h2",{attrs:{id:"_3-1-主从复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-主从复制"}},[t._v("#")]),t._v(" 3.1 主从复制")]),t._v(" "),a("h3",{attrs:{id:"_3-1-1-主从复制简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-主从复制简介"}},[t._v("#")]),t._v(" 3.1.1 主从复制简介")]),t._v(" "),a("h4",{attrs:{id:"_083-主从复制-主从复制简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_083-主从复制-主从复制简介"}},[t._v("#")]),t._v(" 083-主从复制-主从复制简介")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("互联网“三高”架构\n\t高并发\n\t高性能\n\t高可用\n服务器的可用性：\n\t\t\t\t一年的时间"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("秒数"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" 一年总的宕机时间"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("秒数"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ？\n\t\t\t          一年的时间"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("秒数"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t业界可用性目标"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("个"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v("，即"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("99.999")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("，即服务器年宕机时长低于"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("315")]),t._v("秒，约"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.25")]),t._v("分钟\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("你的“ "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Redis")]),t._v('"是否高可用\n\t单机redis的风险与问题\n\t\t问题'),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("机器故障\n\t\t\t现象：硬盘故障、系统崩溃\n\t\t\t质：数据丢失，很可能对业务造成灾难性打击\n\t\t\t结论：基本上会放弃使用 redis\n\t\t问题"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("容量瓶颈\n\t\t\t现象：内存不足，从"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v("G升级到"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("G，从"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("G升级到"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("128")]),t._v("G，无限升级内存\n\t\t\t本质：穷，硬件条件跟不上\n\t\t\t结论：放弃使用 redis\n\t\t结论"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n\t\t\t为了避免单点"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Redis")]),t._v("服务器故障，准备多台服务器，互相连通。将数据复制多个副本\n\t\t\t保存在不同的服务器上，"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'连接在一起'")]),t._v("，并保证数据是"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'同步'")]),t._v("的。即使有其中一台服务器\n\t\t\t宕机，其他服务器依然可以继续提供服务，实现 "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Redis")]),t._v("的高可用，同时实现数据"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'冗余备份'")]),t._v("\n")])])]),a("p",[t._v("多台服务器连接方案")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("多台服务器连接方案：使用这种方式，就可以实现高可用\n\t提供数据方：master\n\t\t主服务器，主节点，主库\n\t\t主客户端\n\t接收数据方：slave\n\t\t从服务器，从节点，从库\n\t\t从客户端\n\t需要解决的问题\n\t\t数据同步\n\t核心工作：\n\t\tmaster的数据复制到save中\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/2020040720080215.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200407201419342.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("由主计算机向从计算机复制数据，这就是这一章要讲的内容：主从复制\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从复制\n\t主从复制即将master中的数据即时、有效的复制到slave中\n\t特征：一个master可以拥有多个slave，一个slave只对应一个master\n\t职责\n\t\tmaster：\n\t\t\t写数据\n\t\t\t执行写操作时，将出现变化的数据自动同步到slave\n\t\t\t读数据（可忽略）\n\t\tslave\n\t\t\t读数据\n\t\t\t写数据（禁止）\n")])])]),a("h4",{attrs:{id:"_084-主从复制-主从复制的作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_084-主从复制-主从复制的作用"}},[t._v("#")]),t._v(" 084-主从复制-主从复制的作用")]),t._v(" "),a("p",[t._v("高可用集群\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200407204032912.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200407204044145.png",alt:""}}),t._v("\n多个maste(master集群)，用到了下面的哨兵\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200407204437822.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从复制的作用\n\t读写分离：\n\t\tmaster写、 slave读，提高服务器的读写负载能力\n\t负载均衡：\n\t\t基于主从结构，配合读写分离，由slave分担master的负载，并根据需求的变化，改变\n\t\tslave的数量，通过多个从节点分担数据读取负载，大大提高"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Redis")]),t._v("服务器并发量与数据吞吐量\n\t故障恢复：\n\t\t当master出现问题的时候，由slave提供服务，实现快速的故障恢复\n\t数据冗余：\n\t\t实现数据热备份，是持久化之外的一种数据冗余方式\n\t高可用基石：\n\t\t基于主从复制，构建哨兵模式与集群，实现"),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Redis")]),t._v("的高可用方案\n")])])]),a("h3",{attrs:{id:"_3-1-2-主从复制工作流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-主从复制工作流程"}},[t._v("#")]),t._v(" 3.1.2 主从复制工作流程")]),t._v(" "),a("h4",{attrs:{id:"_085-主从复制-主从复制的三个阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_085-主从复制-主从复制的三个阶段"}},[t._v("#")]),t._v(" 085-主从复制-主从复制的三个阶段")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从复制工作流程\n\t总述\n\t\t主从复制过程大体可以分为"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("个阶段\n\t\t\t建立连接阶段（即准备阶段）\n\t\t\t数据同步阶段\n\t\t\t命令传播阶段\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200407232502344.png",alt:""}})]),t._v(" "),a("h4",{attrs:{id:"_086-主从复制-工作流程-1-建立连接阶段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_086-主从复制-工作流程-1-建立连接阶段"}},[t._v("#")]),t._v(" 086-主从复制-工作流程（1）建立连接阶段")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从复制工作流程\n\t阶段一：建立连接阶段\n\t\t建立s1ave到master的连接，使master能够识别slave，并保存slave端口号\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("\t建立连接阶段工作流程\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("：设置master的地址和端口，保存master信息 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//1 2 3")]),t._v("\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("：建立socket连接                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//4")]),t._v("\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("：发送ping命令"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("定时器任务"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//5 6 检测是否断开连接")]),t._v("\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("：身份验证                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//7 8")]),t._v("\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("：发送slave端口信息                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//9 10")]),t._v("\n\t\t至此，主从连接成功！\n\n\t最终达到的状态\n\t\tslave：\n\t\t\t保存master的地址和端口\n\t\tmaster：\n\t\t\t保存slave的端口\n\t\t总体：\n\t\t\t它们之间创建了连接的socket，用它来完成信息的交换\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200407233835854.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Redis")]),t._v("一般不对外提供服务"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("功能，外界是看不到它的；都是内网访问，所以说即使不加身份验证也没关系\n")])])]),a("h4",{attrs:{id:"_087-主从复制-搭建主从结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_087-主从复制-搭建主从结构"}},[t._v("#")]),t._v(" 087-主从复制-搭建主从结构")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从复制工作流程\n\t主从连接（slave连接master）\n\t\t方式一：客户端发送命令\n\t\t\tslaveof "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("masterip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("masterport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t\t方式二：启动服务器参数\n\t\t\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("slaveof "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("masterip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("masterport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t\t方式三：服务器配置\n\t\t\tslaveof "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("masterip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("masterport"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n\t\tslave系统信息\n\t\t\tmaster_link_down_since_seconds\n\t\t\tmasterhost\n\t\t\tmasterport\n\t\tmaster系统信息\n\t\t\tslave_listening_port（多个）\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("\t主从断开连接\n\t\t客户端发送命令\n\t\t\tslaveof no one\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("\t授权访问\n\t\tmaster"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'配置文件'")]),t._v("设置密码\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//在配置文件中设置密码")]),t._v("\n\t\t\trequirepass "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t\tmaster客户端发送命令设置密码\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//master已经启动了，想加密码，就在master它的client中通过指令设置密码")]),t._v("\n\t\t\tconfig set requirepass "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t\t\tconfig get requirepass\n\n\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//一旦master设置了密码，slave想访问时，slave必须挂上密码")]),t._v("\n\n\n\t\tslave客户端发送命令设置密码"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//指令里加上密码，来获得master的授权")]),t._v("\n\t\t\tauth "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("password\n\n\t\tslave配置文件设置密码\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//配置文件里加上密码，来获得master的授权")]),t._v("\n\t\t\tauth "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n\t\t启动客户端设置密码\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//访问带密码的master时，必须挂上密码，来获得master的授权")]),t._v("\n\t\t\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cli  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("a  "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("pas sword"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("h4",{attrs:{id:"_088-主从复制-工作流程-2-数据同步阶段-简"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_088-主从复制-工作流程-2-数据同步阶段-简"}},[t._v("#")]),t._v(" 088-主从复制-工作流程（2）数据同步阶段（简）")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("这个阶段：slave找master要数据，master把数据给它\n最终达到的结果：slave与master数据同步\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从复制工作流程\n\t阶段二：数据同步阶段工作流程\n\t\t在s1ave初次连接 master后，复制 master中的所有数据到s1ave\n\t\t将s1ave的数据库状态更新成 master当前的数据库状态\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从复制工作流程\n\t数据同步阶段工作流程 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//全量复制+部分复制")]),t._v("\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("：请求同步数据\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("：创建RDB同步数据\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("：恢复RDB同步数据\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("：请求部分同步数据\n\t\t步骤"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("：恢复部分同步数据\n\t\t至此，数据同步工作完成！\n\t状态\n\t\tslave：\n\t\t\t具有 master端全部数据，包含RDB过程接收的数据\n\t\tmaster：\n\t\t\t保存save当前数据同步的位置\n\t总体：\n\t\t它们之间完成了数据克隆\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200408151204227.png",alt:""}})]),t._v(" "),a("h4",{attrs:{id:"_089-主从复制-数据同步阶段注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_089-主从复制-数据同步阶段注意事项"}},[t._v("#")]),t._v(" 089-主从复制-数据同步阶段注意事项")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("数据同步阶段 master说明\n\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v("如果 master数据量巨大，数据同步阶段应避开流量高峰期，避兔造成 master阻塞，影响业务正常执行\n\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v("复制缓冲区大小设定不合理，会导致数据溢出。如进行全量复制周期太长，进行部分复制时发现数据已经存\n\t  在丢失的情况，必须进行第二次全量复制，致使s1ave陷入死循环状态\n\t  \t\trepl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("backlog"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("size  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("mb\n\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.")]),t._v(" master单机内存占用主机内存的比例不应过大，建议使用"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("50")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("70")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("的内存，留下"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("50")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("的内存用于执行 bgsave命令和创建复制缓冲区\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/202004081536191.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("数据同步阶段slave说明\n\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v("为避免s1ave进行全量复制、部分复制时服务器响应阻塞或数据不同步，建议关闭此期间的对外服务\n\t\tslave"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("serve"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("stale"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("data yes"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("no\n\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v("数据同步阶段， master发送给 slave信息可以理解 master是s1ave的一个客户端，主动向s1ave发送命令\n\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.")]),t._v("多个s1ave同时对 master请求数据同步， master发送的RDB文件增多，会对带宽造成巨大冲击，\n\t  如果master带宽不足，因此数据同步霱要根据业务务需求，适量错峰\n\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.")]),t._v("s1ave过多时，建议调整拓扑结构，由一主多从结构变为树状结构，中间的节点既是master，也是s1ave。\n\t  注意使用树状结构时，由于层级深度，导致深度越高的s1ave与最顶层 master间数据同步延迟较大，数据一致性变差，应谨慎选择\n")])])]),a("h4",{attrs:{id:"_090-主从复制-运行id-runid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_090-主从复制-运行id-runid"}},[t._v("#")]),t._v(" 090-主从复制-运行id(runid)")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从复制工作流程\n\t阶段三：命令传播阶段\n\t\t当 master数据库状态被修改后，导致主从服器数椐库状态不一致，此时需要让主从数据同步到一致的状态，同步的动作称为"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'命令传播'")]),t._v("\n\t\tmaster将接收到的数据变更命令发送给slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("slave接收命令后执行命令\n\n\t命令传播阶段的部分复制\n\t\t命令传播阶段出现了断网现象\n\t\t\t网络闪断闪连 \t\t忽略\n\t\t\t短时间网络中断 \t部分复制\n\t\t\t长时间网络中断\t\t全量复制\n\n\t部分复制的三个核心要素\n\t\t服务器的"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'运行id(run id)'")]),t._v("\n\t\t主服务器的"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'复制积压缓冲区'")]),t._v("\n\t\t主从服务器的"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'复制偏移量'")]),t._v("\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("服务器运行"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("run id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t概念：\n\t\t服务器运行ID是每台服务器每次运行的身份识别码，一台服务器多次运行可以生成多个运行id\n\t组成：\n\t\t运行id由"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("40")]),t._v("位字符组成，是一个随机的十六进制字符\n\t\t例如：fdc9ff13b9bbaab28db42b3d50f852bb5e3fcdce\n\t作用：\n\t\t运行id被用于在服务器间进行传输，识别身份\n\t\t如果想两次操作均对同一台服务器进行，必须毎次操作携带对应的运行id，用于对方识别\n\t实现方式：\n\t\t运行id在每台服务器启动时自动生成的，\n\t\tmaster在首次连接s1ave时，会将自己的运行ID发送给s1ave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tslave保存此ID，通过 info server命令，可以查看节点的run id\n")])])]),a("h4",{attrs:{id:"_091-主从复制-复制缓冲区与偏移量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_091-主从复制-复制缓冲区与偏移量"}},[t._v("#")]),t._v(" 091-主从复制-复制缓冲区与偏移量")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("复制缓冲区\n\t概念：\n\t\t复制缓冲区，又名复制积压缓中区，是一个先进先出（FFO）的队列，用于存储服务器执行过的命令，\n\t\t每次传播命令，master都会将传播的命令记录下来，并存储在复制缓冲区\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200408161008491.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("复制缓冲区内部工作原理\n\t组成：\n\t\t偏移量\n\t\t字节值\n\t工作原理：\n\t\t通过offset区分不同的slave当前数据传播的差异\n\t\tmaster记录已发送的信息对应的offset\n\t\tslave记录已接受的信息对应的offset\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200408161651752.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("复制缓冲区\n\t概念：\n\t\t复制缓冲区，又名复制积压缓冲区，是一个先进先出（FIFO）的队列，用于存储服务器执行过的命令，\n\t\t每次传播命令， master都会将传播的命令记录下来，并存储在复制缓冲区\n\t\t\t复制缓冲区默认数据存储空间大小是"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("M，由于存储空问大小是固定的，\n\t\t\t当入队元素的数量大于队列长度时，最先入队的元素会被弹出，而新元素会被放入队列\n\t由来：\n\t\t每台服务器启动时，如果开启有AOF或被连接成为 master节点，即创建复制缓冲区\n\t作用：\n\t\t用于保存 master收到的所有指令（仅指那些 会影响数据变更的指令，例set"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" select）\n\t数据来源：\n\t\t当 master接收到主客户端的指令时，除了将指令执行，会将该指令存储到缓冲区中\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从服务器复制偏移量（ offset）\n\t概念：\n\t\t一个数字，描述复制缓中区中的指令字节位置\n\t分类：\n\t\tmaster复制偏移量：记录发送给所有s1ave的指令字节对应的位置（多个）\n\t\tslave 复制偏移量：记录s1ave接收 master发送过来的指令字节对应的位置（个）\n\t数据来源：\n\t\tmaste发送一次记录一次\n\t作用：\n\t\t同步信息，比对 master与s1ave的差异，当s1ave断线后，恢复数据使用\n")])])]),a("h4",{attrs:{id:"_092-主从复制-工作流程-2-数据同步与命令传播阶段-全"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_092-主从复制-工作流程-2-数据同步与命令传播阶段-全"}},[t._v("#")]),t._v(" 092-主从复制-工作流程（2）数据同步与命令传播阶段（全）")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200408171944949.png",alt:""}})]),t._v(" "),a("h4",{attrs:{id:"_093-主从复制-心跳机制与命令传播阶段工作流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_093-主从复制-心跳机制与命令传播阶段工作流程"}},[t._v("#")]),t._v(" 093-主从复制-心跳机制与命令传播阶段工作流程")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("心跳机制：进入命令传播阶段候，master与slave间需要进行信息交换，使用心跳机制进行维护，实现双方连接保持在线\n\tmaster心跳："),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//master的心跳，只是为了判断slave是否还连接着")]),t._v("\n\t\t指令：ping\n\t\t周期：由repl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ping"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("slave"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("period决定，默认"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("秒\n\t\t作用：判断slave是否在线\n\t\t查询：INFO replication   \t\t\t\t获取slave最后一次连接时间间隔，lag项维持在"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("或"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("视为正常\n\tslave心跳任务："),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//slave的心跳 1为了获取数据 2判断master是否还连接着自己")]),t._v("\n\t\t指令：REPLCONF ACK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\t周期："),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("秒\n\t\t作用"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("：汇报save自己的复制偏移量，获取最新的数据变更指令\n\t\t作用"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("：判断 master是否在线\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("心跳阶段注意事项\n\t当slave多数掉线，或延迟过高时，master为保障数据稳定性，将拒绝所有信息同步操作\n\t\tmin"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("slaves"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("write "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n\t\tmin"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("slaves"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("max"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("lag "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\n\t\t\tslave数量少于"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("个，或者所有 slave的延迟都大于等于"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("秒时，强制关闭master向slave的写功能，停止数据同步\n\t\tslave数量由：slave发送REPLCONF ACK命令做确认\n\t\tslave延迟由：slave发送 REPLCONF ACK命令做确认\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200408173434905.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"_3-1-3-主从复制常见问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-3-主从复制常见问题"}},[t._v("#")]),t._v(" 3.1.3 主从复制常见问题")]),t._v(" "),a("h4",{attrs:{id:"_094-主从复制-常见问题-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_094-主从复制-常见问题-1"}},[t._v("#")]),t._v(" 094-主从复制-常见问题（1）")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("频繁的全量复制（"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("）\n\t伴随着系统的运行， master的数据量会越来越大，一旦master重启，runid将发生变化，会导致全部s1ave的全量复制操作\n\n\t内部优化调整方案：\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v(" master内部创建master_rep1id变量，使用runid相同的策略生成，长度"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("41")]),t._v("位，并发送给所有slave\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v("在master关闭时执行命令 shutdown save，进行RDB持久化，将runid与 offset保存到RDB文件中\n\t\t\t\trepl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("id\n\t\t\t\trepl "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("offset\n\t\t\t通过 redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("check"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("rdb命令可以查看该信息\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v(" master重启后加载RDB文件，恢复数据\n\t\t\t重启后，将RDB文件中保存的rep1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("id与rep1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("offset加载到内存中\n\t\t\t\tmaster_repl_id     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" repl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("id\n\t\t\t\tmaster_repl_offset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" repl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("offset\n\t\t\t通过info命令可以查看该信息\n\t\t作用"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n\t\t\t本机保存上次runid，重启后恢复该值，使所有slave认为还是之前的master\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("频繁的全量复制（"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("）\n\t问题现象\n\t\t网络环境不佳，出现网络中断，s1ave不提供服务\n\t问题原因\n\t\t复制缓冲区过小，断网后s1ave的offset越界，触发全量复制\n\t最终结果\n\t\tslave反复进行全量复制（导致无法对外提供服务，看起来好像是slave不干活了，实际上它是在忙着进行全量复制）\n\t解决方案\n\t\t修改复制缓冲区大小\n\t\t\trepl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("backlog"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("size\n\t建议设置如下\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v("测算从master到s1ave的重连平均时长 second\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v("获 master平均每秒产生写命令数据总量 write_size_per_second\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.")]),t._v("最优复制缓冲区空间 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" second "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" write_size_per_second\n")])])]),a("h4",{attrs:{id:"_095-主从复制-常见问题-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_095-主从复制-常见问题-2"}},[t._v("#")]),t._v(" 095-主从复制-常见问题（2）")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("频繁的网络中断（"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("）\n\t问题现象\n\t\tmaster的CPU占用过高或s1ave频繁断开连接\n\t问题原因\n\t\ts1ave每"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("秒发送REPLCONF ACK命令到master\n\t\t当s1ave接到了慢查询时"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("keys"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("， geta1l等"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("，会大量占用CPU性能\n\t\tmaster每"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("秒调用复制定时函数 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("replicationCron")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("，比对s1ave发现长时间没有进行响应\n\t最终结果\n\t\tmaster各种资源（输出缓冲区、带宽、连接等）被严重占用\n\t解决方案\n\t\t通过设置合理的超时时间，确认是否释放slave\n\t\t\trep1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("timeout\n\t\t\t该参数定义了超时时间的阈值（默认"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("秒），超过该值，释放s1ave\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("频繁的网络中断（"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("）\n\t问题现象\n\t\ts1ave与 master连接断开\n\t问题原因\n\t\tmaster发送ping指令频度较低\n\t\tmaster设定超时时间较短\n\t\tping指令在网络中存在丢包\n\t解决方案\n\t\t提高ping指令发送的频度\n\t\t\trepl"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ping"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("slave"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("period\n\t\t\t超时时间rep1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("time的时间至少是ping指令频度的"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("到"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("倍，否则s1ave很容易判定超时\n")])])]),a("h4",{attrs:{id:"_096-主从复制-常见问题-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_096-主从复制-常见问题-3"}},[t._v("#")]),t._v(" 096-主从复制-常见问题（3）")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("数据不一致\n\t问题现象\n\t\t多个s1ave获取相同数据不同步\n\t问题原因\n\t\t网络信息不同步，数据发送有延迟\n\t解决方案\n\t\t优化主从间的网络环境，通常放置在同一个机房部署，如使用可里云等云服努器时要注意此现象\n\t\t监控主从节点延迟"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("通过 offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("判断，如果 slave延迟过大，暂时屏蔽程序对该slave的数据访问\n\t\t\tslave"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("serve"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("stale"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("data yes"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("no "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//这个选项开启以后，专门供调试使用，不对外提供服务")]),t._v("\n\t\t\t开启后仅响应 info、 slaveof等少数命令（慎用，除非对数据一致性要求很高）\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主从复制：总结\n\t主从复制\n\t\t什么是主从复制\n\t\t主从复制工作流程\n\t\t\t三个阶段：\n\t\t\t\t连接阶段、数据同步阶段、命令传播阶段\n\t\t\t\t复制分全量复制和部分复制\n\t\t\t三个核心：\n\t\t\t\t部分复制分三个核心：runid、 复制积压缓存区、复制偏移量\n\t\t\t心跳机制\n\t\t\t\t维护着日常的数据传输\n\t\t常见问题\n")])])]),a("h2",{attrs:{id:"_3-2-哨兵模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-哨兵模式"}},[t._v("#")]),t._v(" 3.2 哨兵模式")]),t._v(" "),a("h3",{attrs:{id:"_3-2-1-哨兵简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-哨兵简介"}},[t._v("#")]),t._v(" 3.2.1 哨兵简介")]),t._v(" "),a("h4",{attrs:{id:"_097-哨兵-哨兵简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_097-哨兵-哨兵简介"}},[t._v("#")]),t._v(" 097-哨兵-哨兵简介")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200408184705176.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("\t将宕机的 master下线\n\t找一个slave作为 master\n\t通知所有的save连接新的 master\n\t启动新的 master"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("与save\n\t全量复制"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("N")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("部分复制"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("N")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("配置的不好的话"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("\t谁来确认 master宕机了\n\t找—个主？怎么找法？\n\t修改配置后，原始的主恢复了怎么办？\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200408190049413.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("哨兵简介\n\t哨兵\n\t\t哨兵"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("是—个分布式系统，用于对主从结构中的每台服务器进行"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'监控'")]),t._v("，\n\t\t当岀现故障时通过投票机制"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'选择'")]),t._v("新的master并将所有slave连接到新的master。\n\t\t\t监控：监控它们干活\n\t\t\t选择：出问题谁来做master\n\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("哨兵的作用\n\t监控\n\t\t不断的检查master和slave是否正常运行。\n\t\tmaster存活检测、 master与save运行情兄检测\n\t通知（提醒）\n\t\t当被监控的服务器出现问题时，向其他（哨兵间，客户端）发送通知。\n\t自动故障转移\n\t\t断开master与slave连接，选取一个slave作为master，将其他slave连接到新的 master，并告知客户端新的服务器地址\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("注意：\n\t哨兵也是一台redis服务器，只是不提供数据服务\n\t通常哨兵配置数量为单数"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h3",{attrs:{id:"_3-2-2-启用哨兵模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-启用哨兵模式"}},[t._v("#")]),t._v(" 3.2.2 启用哨兵模式")]),t._v(" "),a("h4",{attrs:{id:"_098-哨兵-哨兵结构搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_098-哨兵-哨兵结构搭建"}},[t._v("#")]),t._v(" 098-哨兵-哨兵结构搭建")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("启用哨兵模式\n\t配置哨兵\n\t\t配置一拖二的主从结构\n\t\t配置三个哨兵（配置相同，端囗不同）\n\t\t\t参看 sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" conf\n\t\t启动哨兵\n\t\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" sentinel1 sentinel1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("端口号"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("conf\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("复制文件，同时把文件中的"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26379")]),t._v("改成"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26380")]),t._v("\nsed "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/26379/26380/g'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("/sentinel"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26379.")]),t._v("conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("/sentinel"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26380.")]),t._v("conf\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("启动顺序：\n\t先启主机，再启从机，最后启哨兵\n\n\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379.")]),t._v("conf\n\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6380.")]),t._v("conf\n\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6381.")]),t._v("conf\n\n\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("sentinel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("sentinel"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26379.")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//启动哨兵1")]),t._v("\n\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cli  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26379")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//启动哨兵1的client")]),t._v("\n\n\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("##########################哨兵的配置文件 sentinel"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26379.")]),t._v("conf##########################\n# 哨兵本身也是一个服务，它对外也有一个服务端口，通常是"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v("\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26380")]),t._v("\n\n# 把哨兵设置为守护进程方式启动，在此不使用它，我们需要看日志文件\ndaemonize no\n\npidfile "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("run"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pid\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n\n# 哨兵的信息存储在哪里\ndir  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("logData\n\n# "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mymaster")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("自定义的名称"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" ：检测的master，本处为 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v("\n# "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" ："),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("个哨兵认定master挂了，那么master就挂了；通常设定为哨兵数量的一半加一\nsentinel monitor mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n\n# 主机master多长时间没响应，认定它挂了，此处是"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("30s")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("秒认定主机下线"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nsentinel down"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("after"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("milliseconds mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30000")]),t._v("\n\n# 新的master上任以后，在进行数据同步以后，一次有多少个开始同步"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("越小，对服务器性能压力越小"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n# 压力越小速度越慢，压力越大 速度越快\n# 说白了就是，有几条线开始用时进行数据同步\nsentinel parallel"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("syncs mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\n# 多长时间内同步完成算有效，即超过这个时间同步没完成算超时"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("分钟认定同步超时"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nsentinel failover"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("timeout mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("180000")]),t._v("\n\nsentinel deny"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("scripts"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("reconfig yes\n\n")])])]),a("ol",[a("li",[t._v("一个master，两个slave\n三个哨兵")]),t._v(" "),a("li",[t._v("使用Ctrl+C停掉master\n然后图片中的哨兵，选举6381为master\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409155713549.png",alt:""}})])]),t._v(" "),a("h3",{attrs:{id:"_3-2-3-哨兵工作原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-3-哨兵工作原理"}},[t._v("#")]),t._v(" 3.2.3 哨兵工作原理")]),t._v(" "),a("h4",{attrs:{id:"_099-哨兵-工作原理-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_099-哨兵-工作原理-1"}},[t._v("#")]),t._v(" 099-哨兵-工作原理（1）")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("哨兵工作原理：主从切换\n\t哨兵在进行主从切换过程中经历三个阶段\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v("监控\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v("通知\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.")]),t._v("故障转移\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("阶段一：监控阶段\n\t用于同步各个节点的状态信息\n\t\t获取各个 sentinel的状态（是否在线）\n\t\t获取 master的状态\n\t\t\tmaster属性\n\t\t\t\trunid\n\t\t\t\trole"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("master\n\t\t\t各个save的详细信息\n\t\t获取所有slave的状态（根据 master中的 "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Slave")]),t._v("信息）\n\t\t\tslave属性\n\t\t\t\trunid\n\t\t\t\trole"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("slave\n\t\t\t\tmaster_host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" master_port\n\t\t\t\toffset\n\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409162530601.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409163354867.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("sentine\n\t会向master、slave、其他sentinel要信息，\n\t通过info要信息，\n\t并与master和slave建立CMD通道"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("每一个sentinel都会和任意一个master和slave建立CMD通道"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("，便于以后的信息流动\nsentinel之间直接会建立一个publish和subscribe通道，进行信息同步\n")])])]),a("h4",{attrs:{id:"_100-哨兵-工作原理-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_100-哨兵-工作原理-2"}},[t._v("#")]),t._v(" 100-哨兵-工作原理（2）")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("哨兵工作原理\n\t阶段二：通知阶段"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("信息的长期维护阶段"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("维护一个长期的信息对等"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409164151768.png",alt:""}})]),t._v(" "),a("h4",{attrs:{id:"_101-哨兵-工作原理-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_101-哨兵-工作原理-3"}},[t._v("#")]),t._v(" 101-哨兵-工作原理（3）")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409165201628.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("上图\n\t一个sentinel向master和slave发送hello指令，收到正常回复，确认它们都正常工作\n\t然后就会在sentinel的局域网内部，告诉大家它们都正常工作\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409165328175.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("上图：\n\t当一个sentinel发现master挂了时，就不停的向master发送hello，但是master没反应\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409195806449.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("上图\n\t这个时候，这个sentinel就认为 这个master挂掉了，\n\t\t会把flags置为SRI_S_DOWN 即主观下线\n\t\t同时向局域网内的其他sentinel说，这个master下线了\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409200228808.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("上图\n\t这个时候，其他的sentinel就会去确认，这个master是否真的下线了\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("各自向master发送hello，并等待回复"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409200244558.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409200257425.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("上图\n\t这时候sentinel们，根据返回来的信息，进行投票，最终投票决定master是否下线\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409200308194.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("上图\n\t投票的数目 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" sentinel的一半时，就都认为master下线了\n\t\t会把flags置为SRI_O_DOWN 即客观下线\n\t\t一旦进入到客观下线阶段，开始进入下一环节：清理队伍\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("主观下线：一台sentinel认为master挂了\n客观下线：超过半数以上的sentinel认为master挂了\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("下图\n\tsentinel中选一个头目，去执行清理队伍的任务\n\t它们会去竞选谁去当这个头目：通过投票机制\n\t\t谁先到达，它就会把票投给谁\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409201654924.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409201446335.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("参与竞选的sentinel会发送的信息包括：\n\t挂的ip和port\n\t自己参与竞选的次数\n\t自己的runid\n如果没有决出胜负：再来一轮，同时竞选次数加一\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409204001319.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409204016657.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("sentinel选出了头目以后，\n\t这个头目就根据自己的四大原则，\n\t从备选服务器中，筛选出一个master\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409221142699.png",alt:""}}),t._v("\n上图：原则1 - 在线的\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409205128889.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409205505205.png",alt:""}}),t._v("\n上图：原则2 - 响应慢的\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/2020040922315578.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409223629880.png",alt:""}}),t._v("\n上图：原则3 - 与原master断开时间久的//即 与原master离得最近的\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409223929565.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409224037629.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("阶段三：故障转移阶段\n\t服务器列表中挑选备选master\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v("在线的\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v("响应慢的\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.")]),t._v("与原master断开时间久的"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//即 与原master离得最近的")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.")]),t._v("优先原则\n\t\t\t优先级\n\t\t\toffset\n\t\t\trunid\n\t发送指令（sentinel）\n\t\t向新的master发送slaveof no one\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//让新的master与上一个master打开从属关系")]),t._v("\n\t\t向其他slave发送slaveof新masterIP端口\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//让其他的slave都连接、隶属于这个新的master的IP和Port")]),t._v("\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("总结\n\n哨兵工作原理\n\t阶段三：故障转移阶段\n\t\t·监控\n\t\t\t同步信息"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//识别对方")]),t._v("\n\t\t·通知\n\t\t\t保持联通"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//保持信息对称")]),t._v("\n\t\t·故障转移\n\t\t\t发现问题\n\t\t\t竞选负责人\n\t\t\t优选新master\n\t\t\t新master上任，其他slave切换master，原master作为slave故障回复后连接\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409230804728.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("下图\n\t现在重新启动原来的master\n\t在哨兵sentinel的界面，可以看到，它转换为slave，slaveof于这个新的master\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200409231029327.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"_3-3-集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-集群"}},[t._v("#")]),t._v(" 3.3 集群")]),t._v(" "),a("h3",{attrs:{id:"_3-3-1-集群简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-1-集群简介"}},[t._v("#")]),t._v(" 3.3.1 集群简介")]),t._v(" "),a("h4",{attrs:{id:"_102-集群-集群简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_102-集群-集群简介"}},[t._v("#")]),t._v(" 102-集群-集群简介")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("现状问题\n\t业务发展过程中遇到的峰值瓶颈\n\t\tredis提供的服务OPS可以达到"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("万"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("秒，当前业务OPS已经达到"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v("万"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("秒\n\t\t内存单机容量达到"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("256")]),t._v("G，当前业务需求内存容量"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("T\n\t使用集群的方式可以快速解决上述问题\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410092257248.png",alt:""}}),t._v("\n一主一从")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410092314646.png",alt:""}}),t._v("\n多主多从")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("集群架构\n\t集群就是使用网络将若干台计算机连通起来，并提供统一的管理方式，使其对外呈现单机的服务效果\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410092612193.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("集群作用\n\t分散单台服务器的访问压力，实现负载均衡\n\t分散单台服务器的存储压力，实现可扩展性\n\t降低单台服务器宕机带来的业务灾难\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410092941837.png",alt:""}})]),t._v(" "),a("h3",{attrs:{id:"_3-3-2-redis集群结构设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2-redis集群结构设计"}},[t._v("#")]),t._v(" 3.3.2 Redis集群结构设计")]),t._v(" "),a("h4",{attrs:{id:"_103-集群-集群存储结构设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_103-集群-集群存储结构设计"}},[t._v("#")]),t._v(" 103-集群-集群存储结构设计")]),t._v(" "),a("h5",{attrs:{id:"_1-数据存储设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-数据存储设计"}},[t._v("#")]),t._v(" 1.数据存储设计")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("集群存储结构设计\n\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v("数据存储设计\n\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v("集群内部通讯设计\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410101936101.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("上图\n\t数据通过算法计算，计算出保存的位置\n\n\t每一份存储空间，称为一个槽\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410102216704.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410102227256.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410102553383.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("上图\n\t增强可扩展性\n\t\t增加了新的存储空间"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("存储节点"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("时\n\t\t就会从原来的每个存储空间里面分出来一部分，存到新增加的这个存储空间\n\n\t\t所谓的增节点和去节点，就是改变这些槽的存储位置\n\n\t\t一个机器持有一定的槽，\n\t\t\t当加机器的时候，把它的槽分一部分给新的机器\n\t\t\t去机器的话，把它的槽，给其他的机器"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("存储节点"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("h5",{attrs:{id:"_2-集群内部通讯设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-集群内部通讯设计"}},[t._v("#")]),t._v(" 2.集群内部通讯设计")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("三个存储机器\n\t它们之间互联\n\t\t谁存储着什么东西，大家心里都一清二楚\n\t\t也就是说，它们心里都有一个账本，记录着各个计算机里面存储的槽"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("存储空间"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410105521335.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("总结\n\t槽用来区分数据内部的存储空间\n\tkey通过算法运算以后，确定它存储的位置\n\t\t查找数据时，要么一次命中 要么两次命中，提高访问性能\n")])])]),a("h3",{attrs:{id:"_3-3-3-cluster集群结构搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-3-cluster集群结构搭建"}},[t._v("#")]),t._v(" 3.3.3 cluster集群结构搭建")]),t._v(" "),a("h4",{attrs:{id:"_104-集群-cluster集群搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_104-集群-cluster集群搭建"}},[t._v("#")]),t._v(" 104-集群-cluster集群搭建")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("cluster集群结构搭建\n\tcluster的conf配置\n\t\t·设置加入cluster，成为其中的节点\n\t\t\tcluster-enabled yeslno\n\t\t·cluster配置文件名，该文件属于自动生成，仅用于快速查找文件并查询文件内容\n\t\t\tcluster-config-file "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\t\t·节点服务响应超时时间，用于判定该节点是否下线或切换为从节点\n\t\t\tcluster-node-timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("milliseconds"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\t\t·master连接的slave最小数量\n\t\t\tcluster-migration-barrier "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("count"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("##########################哨兵的配置文件 sentinel-26379.conf##########################")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 哨兵本身也是一个服务，它对外也有一个服务端口，通常是2+6379")]),t._v("\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26380")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 把哨兵设置为守护进程方式启动，在此不使用它，我们需要看日志文件")]),t._v("\ndaemonize no\n\npidfile /var/run/redis-sentinel.pid\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 哨兵的信息存储在哪里")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dir")]),t._v("  /usr/local/redis-5.0.6/conf/logData\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mymaster(自定义的名称) ：检测的master，本处为 127.0.0.1 6379")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2 ：2个哨兵认定master挂了，那么master就挂了；通常设定为哨兵数量的一半加一")]),t._v("\nsentinel monitor mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 主机master多长时间没响应，认定它挂了，此处是30s(30秒认定主机下线)")]),t._v("\nsentinel down-after-milliseconds mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30000")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 新的master上任以后，在进行数据同步以后，一次有多少个开始同步(越小，对服务器性能压力越小)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 压力越小速度越慢，压力越大 速度越快")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 说白了就是，有几条线开始用时进行数据同步")]),t._v("\nsentinel parallel-syncs mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 多长时间内同步完成算有效，即超过这个时间同步没完成算超时(3分钟认定同步超时)")]),t._v("\nsentinel failover-timeout mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("180000")]),t._v("\n\nsentinel deny-scripts-reconfig "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yes")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("################# 开启cluster集群")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启cluster，这样才能成为集群中的节点")]),t._v("\ncluster-enabled "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("yes")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置文件的名字")]),t._v("\ncluster-config-file nodes-6379.conf\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 这个节点下线的时间，（此处演示，设为10s）")]),t._v("\ncluster-node-timeout "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10000")]),t._v("\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s/6379/6380/g"')]),t._v(" redis-cluster-6379.conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" redis-cluster-6380.conf\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s/6379/6384/g"')]),t._v(" redis-cluster-6379.conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" redis-cluster-6384.conf\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("开一个三主三从的集群结构\n\tmaster1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cluster"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379.")]),t._v("conf\n\tmaster2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cluster"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6380.")]),t._v("conf\n\tmaster3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cluster"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6381.")]),t._v("conf\n\tslave4  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cluster"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6382.")]),t._v("conf\n\tslave5  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cluster"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6383.")]),t._v("conf\n\tslave6  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("server "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("conf"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cluster"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6384.")]),t._v("conf\n\n\t主命令操作客户端"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("大量命令都在这个client中进行操作\n\tmaster1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("client\n\tslave1"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("client\n\t机动客户端"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("需要看其他master和slave客户端时，就用这个机动客户端去看\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410113954230.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("上图\n\t查看各个服务器是否都启动了\n\t下面，我们来把这些节点连接在一起\n\t\t需要用到redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("src目录下的一个redis命令：redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("trib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rb\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410114341175.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("\t\t\t使用redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("trib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rb，需要安装：ruby、gem\n\t\t\t\tyum install ruby\n\t\t\t\tyum install gem\n\n\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@lwh")]),t._v(" src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("# ruby "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v\n\t\t\t\t\truby "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),t._v("p648 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2015")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("x86_64"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("linux"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@lwh")]),t._v(" src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("# gem "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("v\n\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".14")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),t._v("\n\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@lwh")]),t._v(" src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("#\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("使用redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("trib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rb创建集群\n\tcd "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".6")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("src"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("/redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("trib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rb  create "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6380")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6381")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6382")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6383")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6384")]),t._v("\n\n# create"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("创建集群\n# "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" 指定内部结构，"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("代表一个master连接一个slave ，"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" 代表一个master连接两个slave "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n# "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6380")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6381")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6382")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6383")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6384")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" 前面三个是master，后面三个是slave，它们会依次连接\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("# 执行：\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("/redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("trib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rb  create "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6380")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6381")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6382")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6383")]),t._v("\n# 发现并没有执行成功，这是因为：\n\t# "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),t._v("之后 trib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rb 全部移植到了 redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cli "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("cluster， 下面 ruby 和 gem 也不用下载\n# 根据提示：指令变为\n\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cli "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("cluster create "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6380")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6381")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6382")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6383")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6384")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("cluster"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n# 运行这行指令，发现master6379出错，利用fix指令进行修复\n#"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("ERR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Not")]),t._v(" all "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16384")]),t._v(" slots are covered by nodes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\tredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cli "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("cluster fix  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v("\n# 利用check指令，检查是否已经完全修复，可以看出，"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16384")]),t._v("个槽都已经正常\nredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("cli "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),t._v("cluster check "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6379")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("All")]),t._v(" nodes agree about slots configuration"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Check")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("open")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Check")]),t._v(" slots coverage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("All")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16384")]),t._v(" slots covered"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),a("p",[t._v("正常的启动界面如下\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410125944444.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410125956673.png",alt:""}})]),t._v(" "),a("h4",{attrs:{id:"_105-集群-设置与获取数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_105-集群-设置与获取数据"}},[t._v("#")]),t._v(" 105-集群-设置与获取数据")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("集群中：\n\t数据的设置和获取\n")])])]),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/2020041013090832.png",alt:""}}),t._v("\n上图的操作方式，太麻烦了；使用下图的方式操作即可解决\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410131104117.png",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/9acme/assets@note/redis/20200410131441292.png",alt:""}})]),t._v(" "),a("h4",{attrs:{id:"_106-集群-主从下线与主从切换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_106-集群-主从下线与主从切换"}},[t._v("#")]),t._v(" 106-集群-主从下线与主从切换")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("正常的操作，不是cluster最大的优势，它最大的优势是 出问题之后怎么办\n")])])]),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("\tcluster节点"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("手动"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("操作命令\n\t\t·查看集群节点信息\n\t\t\tcluster nodes\n\t\t·进入一个从节点redis，切换其主节点\n\t\t\tcluster replicate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("master"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\t\t·发现一个新节点，新增主节点\n\t\t\tcluster meet ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("port\n\t\t·忽略一个没有solt的节点\n\t\t\tcluster forget "),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\t\t·手动故障转移\n\t\t\tcluster failover\n")])])])])}),[],!1,null,null,null);s.default=r.exports}}]);
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第15章_存储过程与函数 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/css/0.styles.ee72e0a7.css" as="style"><link rel="preload" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/app.4b2b6779.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/2.566dfaa9.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/73.bc251e4e.js" as="script"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/10.4a7b693d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/11.954c58dc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/12.7f7fd0d8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/13.53f60a87.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/14.53939362.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/15.849a5476.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/16.1f6789c6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/17.d72ae9a1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/18.a7d1bb6a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/19.9f13e5f7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/20.cdc3be4f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/21.266d5d1a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/22.f0410055.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/23.5a50d2ee.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/24.9988c973.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/25.ee14d9ff.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/26.0964d115.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/27.74610e13.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/28.3912df6e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/29.d0b5fee3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/3.d2c18c6f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/30.0193ed5a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/31.b2103cdb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/32.21a9a438.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/33.91635cc7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/34.8e9c2f99.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/35.a1720e62.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/36.e4c96f2f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/37.5cdd7165.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/38.413c7d59.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/39.cd3b4e19.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/4.6c7838c9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/40.93d39d6b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/41.69f658c5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/42.fe8735cc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/43.94f2ccbe.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/44.74a2e2e2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/45.da5a1197.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/46.24fd1618.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/47.75cb5bcd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/48.0cff144d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/49.f3837833.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/5.15b5abea.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/50.a7023806.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/51.78a3f132.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/52.e5297431.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/53.0a0b0d46.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/54.b5bd901e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/55.5dcba331.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/56.0eaeb72e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/57.74def2c0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/58.95801003.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/59.01544f40.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/6.a6b9faac.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/60.cdb3bcb3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/61.d303c09a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/62.f28d6c75.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/63.d22fc0d0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/64.2cfd8f97.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/65.e4b431b7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/66.8260abdc.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/67.b7d2c5ae.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/68.b5326c3d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/69.09279bf4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/7.7a8d11a5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/70.9e615b20.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/71.5a3f212b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/72.71337b1e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/74.14797ed5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/75.63a55a44.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/76.902639a3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/77.a05130a5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/78.1a07a06d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/79.50f54a16.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/8.5a81a0ba.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/80.78ade88b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/81.a2273462.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/9.6a351eab.js">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/css/0.styles.ee72e0a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/dist/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/dist/typescript/typescript.html" class="sidebar-link">typescript</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>自定义工具库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>发布NPM包</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>mysql</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dist/mysql/第00章_写在前面.html" class="sidebar-link">总纲</a></li><li><a href="/dist/mysql/第01章_数据库概述.html" class="sidebar-link">概述</a></li><li><a href="/dist/mysql/第02章_MySQL环境搭建.html" class="sidebar-link">环境搭建</a></li><li><a href="/dist/mysql/第03章_基本的SELECT语句.html" class="sidebar-link">基本的SELECT语句</a></li><li><a href="/dist/mysql/第04章_运算符.html" class="sidebar-link">运算符</a></li><li><a href="/dist/mysql/第05章_排序与分页.html" class="sidebar-link">排序与分页</a></li><li><a href="/dist/mysql/第06章_多表查询.html" class="sidebar-link">多表查询</a></li><li><a href="/dist/mysql/第07章_单行函数.html" class="sidebar-link">单行函数</a></li><li><a href="/dist/mysql/第08章_聚合函数.html" class="sidebar-link">聚合函数</a></li><li><a href="/dist/mysql/第09章_子查询.html" class="sidebar-link">子查询</a></li><li><a href="/dist/mysql/第10章_创建和管理表.html" class="sidebar-link">创建和管理表</a></li><li><a href="/dist/mysql/第11章_数据处理之增删改.html" class="sidebar-link">数据处理之增删改</a></li><li><a href="/dist/mysql/第12章_MySQL数据类型精讲.html" class="sidebar-link">数据类型精讲</a></li><li><a href="/dist/mysql/第13章_约束.html" class="sidebar-link">约束</a></li><li><a href="/dist/mysql/第14章_视图.html" class="sidebar-link">视图</a></li><li><a href="/dist/mysql/第15章_存储过程与函数.html" class="active sidebar-link">存储过程与函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_1-存储过程概述" class="sidebar-link">1. 存储过程概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_1-1-理解" class="sidebar-link">1.1 理解</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_1-2-分类" class="sidebar-link">1.2 分类</a></li></ul></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_2-创建存储过程" class="sidebar-link">2. 创建存储过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_2-1-语法分析" class="sidebar-link">2.1 语法分析</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_2-2-代码举例" class="sidebar-link">2.2 代码举例</a></li></ul></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_3-调用存储过程" class="sidebar-link">3. 调用存储过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_3-1-调用格式" class="sidebar-link">3.1 调用格式</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_3-2-代码举例" class="sidebar-link">3.2 代码举例</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_3-3-如何调试" class="sidebar-link">3.3 如何调试</a></li></ul></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_4-存储函数的使用" class="sidebar-link">4. 存储函数的使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_4-1-语法分析" class="sidebar-link">4.1 语法分析</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_4-2-调用存储函数" class="sidebar-link">4.2 调用存储函数</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_4-3-代码举例" class="sidebar-link">4.3 代码举例</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_4-4-对比存储函数和存储过程" class="sidebar-link">4.4 对比存储函数和存储过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_5-存储过程和函数的查看、修改、删除" class="sidebar-link">5. 存储过程和函数的查看、修改、删除</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_5-1-查看" class="sidebar-link">5.1 查看</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_5-2-修改" class="sidebar-link">5.2 修改</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_5-3-删除" class="sidebar-link">5.3 删除</a></li></ul></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_6-关于存储过程使用的争议" class="sidebar-link">6. 关于存储过程使用的争议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_6-1-优点" class="sidebar-link">6.1 优点</a></li><li class="sidebar-sub-header"><a href="/dist/mysql/第15章_存储过程与函数.html#_6-2-缺点" class="sidebar-link">6.2 缺点</a></li></ul></li></ul></li><li><a href="/dist/mysql/第16章_变量、流程控制与游标.html" class="sidebar-link">变量、流程控制与游标</a></li><li><a href="/dist/mysql/第17章_触发器.html" class="sidebar-link">触发器</a></li><li><a href="/dist/mysql/第18章_MySQL8其它新特性.html" class="sidebar-link">MySQL8其它新特性</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>java</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/dist/javaWeb/javaWeb.html" class="sidebar-link">javaWeb</a></li><li><a href="/dist/jdbc/jdbc.html" class="sidebar-link">JDBC</a></li><li><a href="/dist/spring/spring.html" class="sidebar-link">spring</a></li><li><a href="/dist/springMVC/springMVC.html" class="sidebar-link">springMVC</a></li><li><a href="/dist/mybatis/mybatis.html" class="sidebar-link">mybatis</a></li><li><a href="/dist/maven/maven.html" class="sidebar-link">maven</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第15章-存储过程与函数"><a href="#第15章-存储过程与函数" class="header-anchor">#</a> 第15章_存储过程与函数</h1> <p>MySQL从5.0版本开始支持存储过程和函数。存储过程和函数能够将复杂的SQL逻辑封装在一起，应用程序无须关注存储过程和函数内部复杂的SQL逻辑，而只需要简单地调用存储过程和函数即可。</p> <h2 id="_1-存储过程概述"><a href="#_1-存储过程概述" class="header-anchor">#</a> 1. 存储过程概述</h2> <h3 id="_1-1-理解"><a href="#_1-1-理解" class="header-anchor">#</a> 1.1 理解</h3> <p><strong>含义</strong>：存储过程的英文是 <code>Stored Procedure</code>。它的思想很简单，就是一组经过<code>预先编译</code>的 SQL 语句的封装。</p> <p>执行过程：存储过程预先存储在 MySQL 服务器上，需要执行的时候，客户端只需要向服务器端发出调用存储过程的命令，服务器端就可以把预先存储好的这一系列 SQL 语句全部执行。</p> <p><strong>好处</strong>：</p> <p>1、简化操作，提高了sql语句的重用性，减少了开发程序员的压力
2、减少操作过程中的失误，提高效率
3、减少网络传输量（客户端不需要把所有的 SQL 语句通过网络发给服务器）
4、减少了 SQL 语句暴露在网上的风险，也提高了数据查询的安全性</p> <p><strong>和视图、函数的对比</strong>：</p> <p>它和视图有着同样的优点，清晰、安全，还可以减少网络传输量。不过它和视图不同，视图是<code>虚拟表</code>，通常不对底层数据表直接操作，而存储过程是程序化的 SQL，可以<code>直接操作底层数据表</code>，相比于面向集合的操作方式，能够实现一些更复杂的数据处理。</p> <p>一旦存储过程被创建出来，使用它就像使用函数一样简单，我们直接通过调用存储过程名即可。相较于函数，存储过程是<code>没有返回值</code>的。</p> <h3 id="_1-2-分类"><a href="#_1-2-分类" class="header-anchor">#</a> 1.2 分类</h3> <p>存储过程的参数类型可以是IN、OUT和INOUT。根据这点分类如下：</p> <p>1、没有参数（无参数无返回）
2、仅仅带 IN 类型（有参数无返回）
3、仅仅带 OUT 类型（无参数有返回）
4、既带 IN 又带 OUT（有参数有返回）
5、带 INOUT（有参数有返回）</p> <p>注意：IN、OUT、INOUT 都可以在一个存储过程中带多个。</p> <h2 id="_2-创建存储过程"><a href="#_2-创建存储过程" class="header-anchor">#</a> 2. 创建存储过程</h2> <h3 id="_2-1-语法分析"><a href="#_2-1-语法分析" class="header-anchor">#</a> 2.1 语法分析</h3> <p>语法：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> 存储过程名<span class="token punctuation">(</span><span class="token operator">IN</span><span class="token operator">|</span><span class="token keyword">OUT</span><span class="token operator">|</span><span class="token keyword">INOUT</span> 参数名 参数类型<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>characteristics <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token keyword">BEGIN</span>
	存储过程体

<span class="token keyword">END</span>
</code></pre></div><p>类似于Java中的方法：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>修饰符 返回类型 方法名<span class="token punctuation">(</span>参数类型 参数名<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>{

	方法体<span class="token punctuation">;</span>
}
</code></pre></div><p>说明：</p> <p>1、参数前面的符号的意思</p> <ul><li><p><code>IN</code>：当前参数为输入参数，也就是表示入参；</p> <p>存储过程只是读取这个参数的值。如果没有定义参数种类，<code>默认就是 IN</code>，表示输入参数。</p></li> <li><p><code>OUT</code>：当前参数为输出参数，也就是表示出参；</p> <p>执行完成之后，调用这个存储过程的客户端或者应用程序就可以读取这个参数返回的值了。</p></li> <li><p><code>INOUT</code>：当前参数既可以为输入参数，也可以为输出参数。</p></li></ul> <p>2、形参类型可以是 MySQL数据库中的任意类型。</p> <p>3、<code>characteristics</code> 表示创建存储过程时指定的对存储过程的约束条件，其取值信息如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">LANGUAGE</span> <span class="token keyword">SQL</span>
<span class="token operator">|</span> <span class="token punctuation">[</span><span class="token operator">NOT</span><span class="token punctuation">]</span> <span class="token keyword">DETERMINISTIC</span>
<span class="token operator">|</span> { <span class="token keyword">CONTAINS</span> <span class="token keyword">SQL</span> <span class="token operator">|</span> <span class="token keyword">NO</span> <span class="token keyword">SQL</span> <span class="token operator">|</span> <span class="token keyword">READS</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span> <span class="token operator">|</span> <span class="token keyword">MODIFIES</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span> }
<span class="token operator">|</span> <span class="token keyword">SQL</span> SECURITY { <span class="token keyword">DEFINER</span> <span class="token operator">|</span> <span class="token keyword">INVOKER</span> }
<span class="token operator">|</span> <span class="token keyword">COMMENT</span> <span class="token string">'string'</span>
</code></pre></div><ul><li><code>LANGUAGE SQL</code>：说明存储过程执行体是由SQL语句组成的，当前系统支持的语言为SQL。</li> <li><code>[NOT] DETERMINISTIC</code>：指明存储过程执行的结果是否确定。DETERMINISTIC表示结果是确定的。每次执行存储过程时，相同的输入会得到相同的输出。NOT DETERMINISTIC表示结果是不确定的，相同的输入可能得到不同的输出。如果没有指定任意一个值，默认为NOT DETERMINISTIC。</li> <li><code>{ CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA }</code>：指明子程序使用SQL语句的限制。
<ul><li>CONTAINS SQL表示当前存储过程的子程序包含SQL语句，但是并不包含读写数据的SQL语句；</li> <li>NO SQL表示当前存储过程的子程序中不包含任何SQL语句；</li> <li>READS SQL DATA表示当前存储过程的子程序中包含读数据的SQL语句；</li> <li>MODIFIES SQL DATA表示当前存储过程的子程序中包含写数据的SQL语句。</li> <li>默认情况下，系统会指定为CONTAINS SQL。</li></ul></li> <li><code>SQL SECURITY { DEFINER | INVOKER }</code>：执行当前存储过程的权限，即指明哪些用户能够执行当前存储过程。
<ul><li><code>DEFINER</code>表示只有当前存储过程的创建者或者定义者才能执行当前存储过程；</li> <li><code>INVOKER</code>表示拥有当前存储过程的访问权限的用户能够执行当前存储过程。</li> <li>如果没有设置相关的值，则MySQL默认指定值为DEFINER。</li></ul></li> <li><code>COMMENT 'string'</code>：注释信息，可以用来描述存储过程。</li></ul> <p>4、存储过程体中可以有多条 SQL 语句，如果仅仅一条SQL 语句，则可以省略 BEGIN 和 END</p> <p>编写存储过程并不是一件简单的事情，可能存储过程中需要复杂的 SQL 语句。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token number">1.</span> <span class="token keyword">BEGIN</span>…<span class="token keyword">END</span>：<span class="token keyword">BEGIN</span>…<span class="token keyword">END</span> 中间包含了多个语句，每个语句都以（<span class="token punctuation">;</span>）号为结束符。
<span class="token number">2.</span> <span class="token keyword">DECLARE</span>：<span class="token keyword">DECLARE</span> 用来声明变量，使用的位置在于 <span class="token keyword">BEGIN</span>…<span class="token keyword">END</span> 语句中间，而且需要在其他语句使用之前进行变量的声明。
<span class="token number">3.</span> <span class="token keyword">SET</span>：赋值语句，用于对变量进行赋值。
<span class="token number">4.</span> <span class="token keyword">SELECT</span>… <span class="token keyword">INTO</span>：把从数据表中查询的结果存放到变量中，也就是为变量赋值。
</code></pre></div><p>5、需要设置新的结束标记</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> 新的结束标记
</code></pre></div><p>因为MySQL默认的语句结束符号为分号‘;’。为了避免与存储过程中SQL语句结束符相冲突，需要使用DELIMITER改变存储过程的结束符。</p> <p>比如：“DELIMITER //”语句的作用是将MySQL的结束符设置为//，并以“END //”结束存储过程。存储过程定义完毕之后再使用“DELIMITER ;”恢复默认结束符。DELIMITER也可以指定其他符号作为结束符。</p> <p>当使用DELIMITER命令时，应该避免使用反斜杠（‘\’）字符，因为反斜线是MySQL的转义字符。</p> <p>示例：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> 存储过程名<span class="token punctuation">(</span><span class="token operator">IN</span><span class="token operator">|</span><span class="token keyword">OUT</span><span class="token operator">|</span><span class="token keyword">INOUT</span> 参数名  参数类型<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>characteristics <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">sql</span>语句<span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">sql</span>语句<span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">END</span> $
</code></pre></div><h3 id="_2-2-代码举例"><a href="#_2-2-代码举例" class="header-anchor">#</a> 2.2 代码举例</h3> <p>举例1：创建存储过程select_all_data()，查看 emps 表的所有数据</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> select_all_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> emps<span class="token punctuation">;</span>

<span class="token keyword">END</span> $

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>举例2：创建存储过程avg_employee_salary()，返回所有员工的平均工资</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> avg_employee_salary <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> avg_salary <span class="token keyword">FROM</span> emps<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>举例3：创建存储过程show_max_salary()，用来查看“emps”表的最高薪资值。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_max_salary<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">LANGUAGE</span> <span class="token keyword">SQL</span>
	<span class="token operator">NOT</span> <span class="token keyword">DETERMINISTIC</span>
	<span class="token keyword">CONTAINS</span> <span class="token keyword">SQL</span>
	<span class="token keyword">SQL</span> SECURITY <span class="token keyword">DEFINER</span>
	<span class="token keyword">COMMENT</span> <span class="token string">'查看最高薪资'</span>
	<span class="token keyword">BEGIN</span>
		<span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">FROM</span> emps<span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>举例4：创建存储过程show_min_salary()，查看“emps”表的最低薪资值。并将最低薪资通过OUT参数“ms”输出</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_min_salary<span class="token punctuation">(</span><span class="token keyword">OUT</span> ms <span class="token keyword">DOUBLE</span><span class="token punctuation">)</span>
	<span class="token keyword">BEGIN</span>
		<span class="token keyword">SELECT</span> <span class="token function">MIN</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">INTO</span> ms <span class="token keyword">FROM</span> emps<span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>举例5：创建存储过程show_someone_salary()，查看“emps”表的某个员工的薪资，并用IN参数empname输入员工姓名。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_someone_salary<span class="token punctuation">(</span><span class="token operator">IN</span> empname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">BEGIN</span>
		<span class="token keyword">SELECT</span> salary <span class="token keyword">FROM</span> emps <span class="token keyword">WHERE</span> ename <span class="token operator">=</span> empname<span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>举例6：创建存储过程show_someone_salary2()，查看“emps”表的某个员工的薪资，并用IN参数empname输入员工姓名，用OUT参数empsalary输出员工薪资。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_someone_salary2<span class="token punctuation">(</span><span class="token operator">IN</span> empname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">OUT</span> empsalary <span class="token keyword">DOUBLE</span><span class="token punctuation">)</span>
	<span class="token keyword">BEGIN</span>
		<span class="token keyword">SELECT</span> salary <span class="token keyword">INTO</span> empsalary <span class="token keyword">FROM</span> emps <span class="token keyword">WHERE</span> ename <span class="token operator">=</span> empname<span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>举例7：创建存储过程show_mgr_name()，查询某个员工领导的姓名，并用INOUT参数“empname”输入员工姓名，输出领导的姓名。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> show_mgr_name<span class="token punctuation">(</span><span class="token keyword">INOUT</span> empname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">BEGIN</span>
		<span class="token keyword">SELECT</span> ename <span class="token keyword">INTO</span> empname <span class="token keyword">FROM</span> emps
		<span class="token keyword">WHERE</span> eid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> MID <span class="token keyword">FROM</span> emps <span class="token keyword">WHERE</span> ename<span class="token operator">=</span>empname<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-调用存储过程"><a href="#_3-调用存储过程" class="header-anchor">#</a> 3. 调用存储过程</h2> <h3 id="_3-1-调用格式"><a href="#_3-1-调用格式" class="header-anchor">#</a> 3.1 调用格式</h3> <p>存储过程有多种调用方法。存储过程必须使用CALL语句调用，并且存储过程和数据库相关，如果要执行其他数据库中的存储过程，需要指定数据库名称，例如CALL dbname.procname。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CALL</span> 存储过程名<span class="token punctuation">(</span>实参列表<span class="token punctuation">)</span>
</code></pre></div><p><strong>格式：</strong></p> <p>1、调用in模式的参数：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CALL</span> sp1<span class="token punctuation">(</span><span class="token string">'值'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>2、调用out模式的参数：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SET</span> <span class="token variable">@name</span><span class="token punctuation">;</span>
<span class="token keyword">CALL</span> sp1<span class="token punctuation">(</span><span class="token variable">@name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token variable">@name</span><span class="token punctuation">;</span>
</code></pre></div><p>3、调用inout模式的参数：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SET</span> <span class="token variable">@name</span><span class="token operator">=</span>值<span class="token punctuation">;</span>
<span class="token keyword">CALL</span> sp1<span class="token punctuation">(</span><span class="token variable">@name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token variable">@name</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-2-代码举例"><a href="#_3-2-代码举例" class="header-anchor">#</a> 3.2 代码举例</h3> <p><strong>举例1：</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> CountProc<span class="token punctuation">(</span><span class="token operator">IN</span> sid <span class="token keyword">INT</span><span class="token punctuation">,</span><span class="token keyword">OUT</span> num <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">INTO</span> num <span class="token keyword">FROM</span> fruits
	<span class="token keyword">WHERE</span> s_id <span class="token operator">=</span> sid<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>调用存储过程：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">CALL</span> CountProc <span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token variable">@num</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p>查看返回结果：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token variable">@num</span><span class="token punctuation">;</span>
</code></pre></div><p>该存储过程返回了指定 s_id=101 的水果商提供的水果种类，返回值存储在num变量中，使用SELECT查看，返回结果为3。</p> <p>**举例2：**创建存储过程，实现累加运算，计算 1+2+…+n 等于多少。具体的代码如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>add_num<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token operator">IN</span> n <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
       <span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span><span class="token punctuation">;</span>
       <span class="token keyword">DECLARE</span> sum <span class="token keyword">INT</span><span class="token punctuation">;</span>

       <span class="token keyword">SET</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token keyword">SET</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">WHILE</span> i <span class="token operator">&lt;=</span> n <span class="token keyword">DO</span>
              <span class="token keyword">SET</span> sum <span class="token operator">=</span> sum <span class="token operator">+</span> i<span class="token punctuation">;</span>
              <span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
       <span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
       <span class="token keyword">SELECT</span> sum<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>如果你用的是 Navicat 工具，那么在编写存储过程的时候，Navicat 会自动设置 DELIMITER 为其他符号，我们不需要再进行 DELIMITER 的操作。</p> <p>直接使用 <code>CALL add_num(50);</code>即可。这里我传入的参数为 50，也就是统计 1+2+…+50 的积累之和。</p> <h3 id="_3-3-如何调试"><a href="#_3-3-如何调试" class="header-anchor">#</a> 3.3 如何调试</h3> <p>在 MySQL 中，存储过程不像普通的编程语言（比如 VC++、Java 等）那样有专门的集成开发环境。因此，你可以通过 SELECT 语句，把程序执行的中间结果查询出来，来调试一个 SQL 语句的正确性。调试成功之后，把 SELECT 语句后移到下一个 SQL 语句之后，再调试下一个 SQL 语句。这样<code>逐步推进</code>，就可以完成对存储过程中所有操作的调试了。当然，你也可以把存储过程中的 SQL 语句复制出来，逐段单独调试。</p> <h2 id="_4-存储函数的使用"><a href="#_4-存储函数的使用" class="header-anchor">#</a> 4. 存储函数的使用</h2> <p>前面学习了很多函数，使用这些函数可以对数据进行的各种处理操作，极大地提高用户对数据库的管理效率。MySQL支持自定义函数，定义好之后，调用方式与调用MySQL预定义的系统函数一样。</p> <h3 id="_4-1-语法分析"><a href="#_4-1-语法分析" class="header-anchor">#</a> 4.1 语法分析</h3> <p>学过的函数：LENGTH、SUBSTR、CONCAT等</p> <p>语法格式：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> 函数名<span class="token punctuation">(</span>参数名 参数类型<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> 返回值类型
<span class="token punctuation">[</span>characteristics <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token keyword">BEGIN</span>
	函数体   <span class="token comment">#函数体中肯定有 RETURN 语句</span>

<span class="token keyword">END</span>
</code></pre></div><p>说明：</p> <p>1、参数列表：指定参数为IN、OUT或INOUT只对PROCEDURE是合法的，FUNCTION中总是默认为IN参数。</p> <p>2、RETURNS type 语句表示函数返回数据的类型；</p> <p>RETURNS子句只能对FUNCTION做指定，对函数而言这是<code>强制</code>的。它用来指定函数的返回类型，而且函数体必须包含一个<code>RETURN value</code>语句。</p> <p>3、characteristic 创建函数时指定的对函数的约束。取值与创建存储过程时相同，这里不再赘述。</p> <p>4、函数体也可以用BEGIN…END来表示SQL代码的开始和结束。如果函数体只有一条语句，也可以省略BEGIN…END。</p> <h3 id="_4-2-调用存储函数"><a href="#_4-2-调用存储函数" class="header-anchor">#</a> 4.2 调用存储函数</h3> <p>在MySQL中，存储函数的使用方法与MySQL内部函数的使用方法是一样的。换言之，用户自己定义的存储函数与MySQL内部函数是一个性质的。区别在于，存储函数是<code>用户自己定义</code>的，而内部函数是MySQL的<code>开发者定义</code>的。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 函数名<span class="token punctuation">(</span>实参列表<span class="token punctuation">)</span>
</code></pre></div><h3 id="_4-3-代码举例"><a href="#_4-3-代码举例" class="header-anchor">#</a> 4.3 代码举例</h3> <p><strong>举例1：</strong></p> <p>创建存储函数，名称为email_by_name()，参数定义为空，该函数查询Abel的email，并返回，数据类型为字符串型。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>

<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> email_by_name<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>
<span class="token keyword">DETERMINISTIC</span>
<span class="token keyword">CONTAINS</span> <span class="token keyword">SQL</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">RETURN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> email <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> last_name <span class="token operator">=</span> <span class="token string">'Abel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>调用：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> email_by_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>举例2：</strong></p> <p>创建存储函数，名称为email_by_id()，参数传入emp_id，该函数查询emp_id的email，并返回，数据类型为字符串型。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>

<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> email_by_id<span class="token punctuation">(</span>emp_id <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>
<span class="token keyword">DETERMINISTIC</span>
<span class="token keyword">CONTAINS</span> <span class="token keyword">SQL</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">RETURN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> email <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> employee_id <span class="token operator">=</span> emp_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>调用：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SET</span> <span class="token variable">@emp_id</span> <span class="token operator">=</span> <span class="token number">102</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> email_by_id<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>举例3：</strong></p> <p>创建存储函数count_by_id()，参数传入dept_id，该函数查询dept_id部门的员工人数，并返回，数据类型为整型。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token comment">//</span>

<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> count_by_id<span class="token punctuation">(</span>dept_id <span class="token keyword">INT</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">INT</span>
	<span class="token keyword">LANGUAGE</span> <span class="token keyword">SQL</span>
	<span class="token operator">NOT</span> <span class="token keyword">DETERMINISTIC</span>
	<span class="token keyword">READS</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span>
	<span class="token keyword">SQL</span> SECURITY <span class="token keyword">DEFINER</span>
	<span class="token keyword">COMMENT</span> <span class="token string">'查询部门平均工资'</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">RETURN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> employees <span class="token keyword">WHERE</span> department_id <span class="token operator">=</span> dept_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">END</span> <span class="token comment">//</span>

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>调用：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SET</span> <span class="token variable">@dept_id</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> count_by_id<span class="token punctuation">(</span><span class="token variable">@dept_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意：</strong></p> <p>若在创建存储函数中报错“<code>you might want to use the less safe log_bin_trust_function_creators variable</code>”，有两种处理方法：</p> <ul><li><p>方式1：加上必要的函数特性“[NOT] DETERMINISTIC”和“{CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA}”</p></li> <li><p>方式2：</p></li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> log_bin_trust_function_creators <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-4-对比存储函数和存储过程"><a href="#_4-4-对比存储函数和存储过程" class="header-anchor">#</a> 4.4 对比存储函数和存储过程</h3> <table><thead><tr><th></th> <th>关键字</th> <th>调用语法</th> <th>返回值</th> <th>应用场景</th></tr></thead> <tbody><tr><td>存储过程</td> <td>PROCEDURE</td> <td>CALL 存储过程()</td> <td>理解为有0个或多个</td> <td>一般用于更新</td></tr> <tr><td>存储函数</td> <td>FUNCTION</td> <td>SELECT 函数()</td> <td>只能是一个</td> <td>一般用于查询结果为一个值并返回时</td></tr></tbody></table> <p>此外，<strong>存储函数可以放在查询语句中使用，存储过程不行</strong>。反之，存储过程的功能更加强大，包括能够执行对表的操作（比如创建表，删除表等）和事务操作，这些功能是存储函数不具备的。</p> <h2 id="_5-存储过程和函数的查看、修改、删除"><a href="#_5-存储过程和函数的查看、修改、删除" class="header-anchor">#</a> 5. 存储过程和函数的查看、修改、删除</h2> <h3 id="_5-1-查看"><a href="#_5-1-查看" class="header-anchor">#</a> 5.1 查看</h3> <p>创建完之后，怎么知道我们创建的存储过程、存储函数是否成功了呢？</p> <p>MySQL存储了存储过程和函数的状态信息，用户可以使用SHOW STATUS语句或SHOW CREATE语句来查看，也可直接从系统的information_schema数据库中查询。这里介绍3种方法。</p> <p><strong>1. 使用SHOW CREATE语句查看存储过程和函数的创建信息</strong></p> <p>基本语法结构如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> {<span class="token keyword">PROCEDURE</span> <span class="token operator">|</span> <span class="token keyword">FUNCTION</span>} 存储过程名或函数名
</code></pre></div><p>举例：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SHOW</span> <span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> test_db<span class="token punctuation">.</span>CountProc \G
</code></pre></div><p><strong>2. 使用SHOW STATUS语句查看存储过程和函数的状态信息</strong></p> <p>基本语法结构如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SHOW</span> {<span class="token keyword">PROCEDURE</span> <span class="token operator">|</span> <span class="token keyword">FUNCTION</span>} <span class="token keyword">STATUS</span> <span class="token punctuation">[</span><span class="token operator">LIKE</span> <span class="token string">'pattern'</span><span class="token punctuation">]</span>
</code></pre></div><p>这个语句返回子程序的特征，如数据库、名字、类型、创建者及创建和修改日期。</p> <p>[LIKE 'pattern']：匹配存储过程或函数的名称，可以省略。当省略不写时，会列出MySQL数据库中存在的所有存储过程或函数的信息。
举例：SHOW STATUS语句示例，代码如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SHOW</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">STATUS</span> <span class="token operator">LIKE</span> <span class="token string">'SELECT%'</span> \G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
                  Db: test_db
                Name: SelectAllData
                <span class="token keyword">Type</span>: <span class="token keyword">PROCEDURE</span>
             <span class="token keyword">Definer</span>: root<span class="token variable">@localhost</span>
            Modified: <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">15</span>:<span class="token number">55</span>:<span class="token number">07</span>
             Created: <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">15</span>:<span class="token number">55</span>:<span class="token number">07</span>
       Security_type: <span class="token keyword">DEFINER</span>
             <span class="token keyword">Comment</span>:
character_set_client: utf8mb4
collation_connection: utf8mb4_general_ci
  <span class="token keyword">Database</span> Collation: utf8mb4_general_ci
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre></div><p><strong>3. 从information_schema.Routines表中查看存储过程和函数的信息</strong></p> <p>MySQL中存储过程和函数的信息存储在information_schema数据库下的Routines表中。可以通过查询该表的记录来查询存储过程和函数的信息。其基本语法形式如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>Routines
<span class="token keyword">WHERE</span> ROUTINE_NAME<span class="token operator">=</span><span class="token string">'存储过程或函数的名'</span> <span class="token punctuation">[</span><span class="token operator">AND</span> ROUTINE_TYPE <span class="token operator">=</span> {<span class="token string">'PROCEDURE|FUNCTION'</span>}<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>说明：如果在MySQL数据库中存在存储过程和函数名称相同的情况，最好指定ROUTINE_TYPE查询条件来指明查询的是存储过程还是函数。</p> <p>举例：从Routines表中查询名称为CountProc的存储函数的信息，代码如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>Routines
<span class="token keyword">WHERE</span> ROUTINE_NAME<span class="token operator">=</span><span class="token string">'count_by_id'</span>　<span class="token operator">AND</span>　ROUTINE_TYPE <span class="token operator">=</span> <span class="token string">'FUNCTION'</span> \G
</code></pre></div><h3 id="_5-2-修改"><a href="#_5-2-修改" class="header-anchor">#</a> 5.2 修改</h3> <p>修改存储过程或函数，不影响存储过程或函数功能，只是修改相关特性。使用ALTER语句实现。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">ALTER</span> {<span class="token keyword">PROCEDURE</span> <span class="token operator">|</span> <span class="token keyword">FUNCTION</span>} 存储过程或函数的名 <span class="token punctuation">[</span>characteristic <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre></div><p>其中，characteristic指定存储过程或函数的特性，其取值信息与创建存储过程、函数时的取值信息略有不同。</p> <div class="language-sql extra-class"><pre class="language-sql"><code>{ <span class="token keyword">CONTAINS</span> <span class="token keyword">SQL</span> <span class="token operator">|</span> <span class="token keyword">NO</span> <span class="token keyword">SQL</span> <span class="token operator">|</span> <span class="token keyword">READS</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span> <span class="token operator">|</span> <span class="token keyword">MODIFIES</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span> }
<span class="token operator">|</span> <span class="token keyword">SQL</span> SECURITY { <span class="token keyword">DEFINER</span> <span class="token operator">|</span> <span class="token keyword">INVOKER</span> }
<span class="token operator">|</span> <span class="token keyword">COMMENT</span> <span class="token string">'string'</span>
</code></pre></div><ul><li><code>CONTAINS SQL</code>，表示子程序包含SQL语句，但不包含读或写数据的语句。</li> <li><code>NO SQL</code>，表示子程序中不包含SQL语句。</li> <li><code>READS SQL DATA</code>，表示子程序中包含读数据的语句。</li> <li><code>MODIFIES SQL DATA</code>，表示子程序中包含写数据的语句。</li> <li><code>SQL SECURITY { DEFINER | INVOKER }</code>，指明谁有权限来执行。
<ul><li><code>DEFINER</code>，表示只有定义者自己才能够执行。</li> <li><code>INVOKER</code>，表示调用者可以执行。</li></ul></li> <li><code>COMMENT 'string'</code>，表示注释信息。</li></ul> <blockquote><p>修改存储过程使用ALTER PROCEDURE语句，修改存储函数使用ALTER FUNCTION语句。但是，这两个语句的结构是一样的，语句中的所有参数也是一样的。</p></blockquote> <p><strong>举例1：</strong></p> <p>修改存储过程CountProc的定义。将读写权限改为MODIFIES SQL DATA，并指明调用者可以执行，代码如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">ALTER</span>　<span class="token keyword">PROCEDURE</span>　CountProc
<span class="token keyword">MODIFIES</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span>
<span class="token keyword">SQL</span> SECURITY <span class="token keyword">INVOKER</span> <span class="token punctuation">;</span>
</code></pre></div><p>查询修改后的信息：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> specific_name<span class="token punctuation">,</span>sql_data_access<span class="token punctuation">,</span>security_type
<span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token punctuation">`</span>ROUTINES<span class="token punctuation">`</span>
<span class="token keyword">WHERE</span> routine_name <span class="token operator">=</span> <span class="token string">'CountProc'</span> <span class="token operator">AND</span> routine_type <span class="token operator">=</span> <span class="token string">'PROCEDURE'</span><span class="token punctuation">;</span>
</code></pre></div><p>结果显示，存储过程修改成功。从查询的结果可以看出，访问数据的权限（SQL_DATA_ ACCESS）已经变成MODIFIES SQL DATA，安全类型（SECURITY_TYPE）已经变成INVOKER。</p> <p><strong>举例2：</strong></p> <p>修改存储函数CountProc的定义。将读写权限改为READS SQL DATA，并加上注释信息“FIND NAME”，代码如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">ALTER</span>　<span class="token keyword">FUNCTION</span>　CountProc
<span class="token keyword">READS</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span>
<span class="token keyword">COMMENT</span> <span class="token string">'FIND NAME'</span> <span class="token punctuation">;</span>
</code></pre></div><p>存储函数修改成功。从查询的结果可以看出，访问数据的权限（SQL_DATA_ACCESS）已经变成READS SQL DATA，函数注释（ROUTINE_COMMENT）已经变成FIND NAME。</p> <h3 id="_5-3-删除"><a href="#_5-3-删除" class="header-anchor">#</a> 5.3 删除</h3> <p>删除存储过程和函数，可以使用DROP语句，其语法结构如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> {<span class="token keyword">PROCEDURE</span> <span class="token operator">|</span> <span class="token keyword">FUNCTION</span>} <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> 存储过程或函数的名
</code></pre></div><p>IF EXISTS：如果程序或函数不存储，它可以防止发生错误，产生一个用SHOW WARNINGS查看的警告。</p> <p>举例：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> CountProc<span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> CountProc<span class="token punctuation">;</span>
</code></pre></div><h2 id="_6-关于存储过程使用的争议"><a href="#_6-关于存储过程使用的争议" class="header-anchor">#</a> 6. 关于存储过程使用的争议</h2> <p>尽管存储过程有诸多优点，但是对于存储过程的使用，<strong>一直都存在着很多争议</strong>，比如有些公司对于大型项目要求使用存储过程，而有些公司在手册中明确禁止使用存储过程，为什么这些公司对存储过程的使用需求差别这么大呢？</p> <h3 id="_6-1-优点"><a href="#_6-1-优点" class="header-anchor">#</a> 6.1 优点</h3> <p>**1、存储过程可以一次编译多次使用。**存储过程只在创建时进行编译，之后的使用都不需要重新编译，这就提升了 SQL 的执行效率。</p> <p>**2、可以减少开发工作量。**将代码<code>封装</code>成模块，实际上是编程的核心思想之一，这样可以把复杂的问题拆解成不同的模块，然后模块之间可以<code>重复使用</code>，在减少开发工作量的同时，还能保证代码的结构清晰。</p> <p>**3、存储过程的安全性强。**我们在设定存储过程的时候可以<code>设置对用户的使用权限</code>，这样就和视图一样具有较强的安全性。</p> <p>**4、可以减少网络传输量。**因为代码封装到存储过程中，每次使用只需要调用存储过程即可，这样就减少了网络传输量。</p> <p>**5、良好的封装性。**在进行相对复杂的数据库操作时，原本需要使用一条一条的 SQL 语句，可能要连接多次数据库才能完成的操作，现在变成了一次存储过程，只需要<code>连接一次即可</code>。</p> <h3 id="_6-2-缺点"><a href="#_6-2-缺点" class="header-anchor">#</a> 6.2 缺点</h3> <p>基于上面这些优点，不少大公司都要求大型项目使用存储过程，比如微软、IBM 等公司。但是国内的阿里并不推荐开发人员使用存储过程，这是为什么呢？</p> <blockquote><h4 id="阿里开发规范"><a href="#阿里开发规范" class="header-anchor">#</a> 阿里开发规范</h4> <p>【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。</p></blockquote> <p>存储过程虽然有诸如上面的好处，但缺点也是很明显的。</p> <p>**1、可移植性差。**存储过程不能跨数据库移植，比如在 MySQL、Oracle 和 SQL Server 里编写的存储过程，在换成其他数据库时都需要重新编写。</p> <p>**2、调试困难。**只有少数 DBMS 支持存储过程的调试。对于复杂的存储过程来说，开发和维护都不容易。虽然也有一些第三方工具可以对存储过程进行调试，但要收费。</p> <p>**3、存储过程的版本管理很困难。**比如数据表索引发生变化了，可能会导致存储过程失效。我们在开发软件的时候往往需要进行版本管理，但是存储过程本身没有版本控制，版本迭代更新的时候很麻烦。</p> <p>**4、它不适合高并发的场景。**高并发的场景需要减少数据库的压力，有时数据库会采用分库分表的方式，而且对可扩展性要求很高，在这种情况下，存储过程会变得难以维护，<code>增加数据库的压力</code>，显然就不适用了。</p> <p>小结：</p> <p>存储过程既方便，又有局限性。尽管不同的公司对存储过程的态度不一，但是对于我们开发人员来说，不论怎样，掌握存储过程都是必备的技能之一。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/app.4b2b6779.js" defer></script><script src="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/2.566dfaa9.js" defer></script><script src="https://cdn.jsdelivr.net/gh/9acme/note/dist/assets/js/73.bc251e4e.js" defer></script>
  </body>
</html>
